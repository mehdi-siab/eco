<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGuardian - Historical Monuments AR Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.3.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Custom Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'eco-primary': '#2a9d8f',
                        'eco-primary-light': '#3bc1b1',
                        'eco-primary-dark': '#238a7d',
                        'eco-secondary': '#e9c46a', // Used for accents in quiz
                        'eco-danger': '#e76f51',
                        'eco-success': '#52b788',
                        'eco-info': '#3498db', // Used for primary actions in quiz
                        'eco-text-primary': '#333333',
                        'eco-text-secondary': '#666666',
                        'eco-background': '#f5f7fa',
                        'eco-surface': '#ffffff',
                        'quiz-correct-bg': '#e6fffa', // Light green for correct
                        'quiz-correct-border': '#38a169', // Green-600
                        'quiz-incorrect-bg': '#fff5f5', // Light red for incorrect
                        'quiz-incorrect-border': '#e53e3e', // Red-600
                    }
                }
            }
        }
    </script>
    <style>
        /* Global body style for AR scene to take full screen when active */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars when AR scene is active */
            font-family: 'Poppins', sans-serif;
        }

        /* Specific styles for AR scene and overlays */
        .ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; /* Ensure overlays are above AR scene */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.75); /* Semi-transparent background */
            color: white;
            padding: 1rem;
            box-sizing: border-box;
        }

        #ar-scene-container { /* Renamed from #ar-scene for clarity */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Below UI overlays */
            display: none; /* Initially hidden */
        }

        /* Fallback view styling */
        #fallback-view {
            z-index: 1; /* Match AR scene z-index */
        }

        /* Loading Indicator Spinner */
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3; /* Light grey */
            border-top: 6px solid #e9c46a; /* eco-secondary */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ensure UI controls are visible */
        #ui-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 20; /* Above AR scene and other overlays if needed */
        }
        .quiz-option.selected {
            background-color: #e0f2fe; /* light-blue-100 */
            border-color: #0ea5e9; /* sky-500 */
        }
        .quiz-option.correct {
            background-color: theme('colors.quiz-correct-bg');
            border-color: theme('colors.quiz-correct-border');
            color: theme('colors.quiz-correct-border');
        }
        .quiz-option.incorrect {
            background-color: theme('colors.quiz-incorrect-bg');
            border-color: theme('colors.quiz-incorrect-border');
            color: theme('colors.quiz-incorrect-border');
        }
    </style>
</head>
<body class="bg-eco-background">

    <div id="welcome-screen" class="ar-overlay text-center">
        <div class="bg-eco-surface text-eco-text-primary p-6 sm:p-8 rounded-xl shadow-2xl max-w-xl w-full">
            <i class="fas fa-landmark text-5xl text-eco-primary mb-4"></i>
            <h1 class="text-3xl sm:text-4xl font-bold text-eco-primary mb-4">Historical Monuments AR Quiz</h1>
            <p class="text-eco-text-secondary mb-3 text-sm sm:text-base">Explore famous historical monuments in Augmented Reality and test your knowledge!</p>
            <p class="text-eco-text-secondary mb-6 text-xs sm:text-sm">Point your camera at a flat surface. Models will appear in AR. Tap them to start the quiz. (AR requires a compatible device/browser).</p>
            <button class="start-btn bg-eco-primary hover:bg-eco-primary-dark text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 text-base sm:text-lg" id="start-experience">
                Start Exploring <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <div id="monument-selection" class="ar-overlay hidden overflow-y-auto bg-eco-background">
        <div class="container mx-auto px-4 py-8 w-full max-w-4xl">
            <h2 class="text-3xl font-bold text-eco-primary text-center mb-8">Select a Monument</h2>
            <div class="monuments-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
             <button id="back-to-welcome" class="mt-8 bg-gray-200 hover:bg-gray-300 text-eco-text-primary font-semibold py-2 px-6 rounded-lg shadow transition-colors block mx-auto">
                <i class="fas fa-home mr-2"></i> Back to Welcome
            </button>
        </div>
    </div>

    <div id="ar-scene-container">
        <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
            <a-entity camera></a-entity>
            <a-marker preset="hiro" id="monument-marker">
                <a-entity id="monument-model" scale="0.1 0.1 0.1" rotation="0 0 0" position="0 0.5 0"></a-entity>
            </a-marker>
        </a-scene>
    </div>

    <div id="fallback-view" class="ar-overlay hidden bg-eco-background items-center justify-center p-4">
        <div class="bg-eco-surface p-6 rounded-lg shadow-xl max-w-lg w-full text-center">
            <h3 id="fallback-title" class="text-2xl font-semibold text-eco-primary mb-4">Monument View</h3>
            <img id="fallback-image" src="https://placehold.co/400x300/e2e8f0/9ca3af?text=Monument+Image" alt="Monument Image" class="rounded-lg shadow-md mx-auto mb-4 max-h-64 object-contain">
            <p id="fallback-description" class="text-eco-text-secondary text-sm mb-6">Detailed description of the monument.</p>
            <button id="start-quiz-fallback" class="bg-eco-info hover:bg-opacity-90 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors">
                Start Quiz
            </button>
        </div>
    </div>

    <div id="quiz-container" class="fixed bottom-0 left-0 right-0 bg-eco-surface p-4 sm:p-6 shadow-2xl rounded-t-2xl transform translate-y-full transition-transform duration-500 ease-in-out z-20 max-h-[85vh] overflow-y-auto" style="border-top: 4px solid #e9c46a;">
        <div class="max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-3">
                <h3 id="quiz-title" class="text-xl sm:text-2xl font-bold text-eco-primary">Monument Quiz</h3>
                <div class="text-sm text-eco-text-secondary">
                    Score: <span id="current-score" class="font-semibold">0</span>/<span id="total-questions" class="font-semibold">0</span>
                </div>
            </div>
            <img id="quiz-image-stimulus" src="https://placehold.co/400x200/e2e8f0/9ca3af?text=Question+Image" alt="Question related image" class="rounded-lg shadow mx-auto mb-4 max-h-40 object-contain hidden">
            <p id="quiz-question" class="text-base sm:text-lg text-eco-text-primary mb-4 min-h-[3em]">Question text will load here...</p>
            
            <div class="quiz-options grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                </div>
            
            <div id="quiz-feedback" class="p-3 rounded-md text-sm mb-4 hidden">
                </div>
            
            <div class="quiz-footer flex flex-col sm:flex-row justify-between items-center gap-3">
                <button id="try-again-btn" class="w-full sm:w-auto bg-eco-secondary hover:bg-opacity-90 text-eco-text-primary font-semibold py-2.5 px-5 rounded-lg shadow transition-colors hidden">
                    <i class="fas fa-redo mr-2"></i> Try Again
                </button>
                <button id="next-question-btn" class="w-full sm:w-auto bg-eco-info hover:bg-opacity-90 text-white font-semibold py-2.5 px-5 rounded-lg shadow transition-colors hidden">
                    Next Question <i class="fas fa-arrow-right ml-2"></i>
                </button>
                 <button id="view-facts-btn" class="w-full sm:w-auto bg-eco-success hover:bg-opacity-90 text-white font-semibold py-2.5 px-5 rounded-lg shadow transition-colors hidden">
                    View Facts <i class="fas fa-info-circle ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="edu-facts-container" class="ar-overlay hidden bg-eco-background items-center justify-center p-4 overflow-y-auto">
        <div class="bg-eco-surface p-6 sm:p-8 rounded-xl shadow-2xl max-w-2xl w-full text-eco-text-primary max-h-[90vh] overflow-y-auto">
            <div id="edu-facts-image" class="w-full h-48 sm:h-64 bg-gray-200 rounded-lg mb-4 bg-cover bg-center shadow"></div>
            <h3 id="edu-facts-title" class="text-2xl sm:text-3xl font-bold text-eco-primary mb-3 text-center">Fun Facts</h3>
            <div id="edu-facts-content" class="text-sm sm:text-base text-eco-text-secondary mb-6 space-y-2 leading-relaxed">
                </div>
            <button class="edu-facts-btn bg-eco-primary hover:bg-eco-primary-dark text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 w-full text-base sm:text-lg" id="continue-btn">
                Continue Exploring <i class="fas fa-map-signs ml-2"></i>
            </button>
        </div>
    </div>

    <div id="ui-controls" class="hidden"> <button id="back-btn" class="bg-white hover:bg-gray-100 text-eco-text-primary font-bold w-12 h-12 rounded-full shadow-lg flex items-center justify-center transition-colors">
            <i class="fas fa-arrow-left text-xl"></i>
        </button>
    </div>

    <div id="loading-indicator" class="ar-overlay hidden">
        <div class="spinner"></div>
        <p class="mt-4 text-lg">Loading AR Experience...</p>
    </div>

    <script>
        // --- Game State & Data (Simplified from original, adapt as needed) ---
        const gameState = {
            currentScreen: 'welcome', // welcome, selection, ar, fallback, quiz, facts
            currentMonument: null,
            currentQuestionIndex: 0,
            score: 0,
            selectedOptionElement: null,
            questionAnswered: false,
            completedMonuments: {}, // { monumentId: true }
            arSupported: false
        };

        const monuments = [
            // Using only one monument for brevity in this example. Add more as in your original file.
            {
                id: "great-pyramid",
                name: "The Great Pyramid",
                location: "Giza, Egypt",
                image: "https://placehold.co/300x200/e9c46a/333333?text=Pyramid", // Placeholder
                modelSrc: "https://cdn.glitch.global/cbO4O9fO9S/pyramid.glb", // Example GLB, replace with actual
                fallbackImage: "https://placehold.co/400x300/e9c46a/333333?text=Pyramid+View",
                description: "The Great Pyramid of Giza is the oldest and largest of the three pyramids in the Giza pyramid complex.",
                questions: [
                    { question: "When was it built?", options: ["2560 BCE", "1200 BCE", "500 CE"], correctAnswer: 0, feedback: "Built around 2560 BCE for Pharaoh Khufu.", image: "https://placehold.co/400x200/cccccc/333333?text=Pyramid+Construction" },
                    { question: "Original height?", options: ["147m", "100m", "200m"], correctAnswer: 0, feedback: "Originally 147 meters (481 feet) tall." },
                    { question: "Made of how many stones?", options: ["~1 million", "~2.3 million", "~500k"], correctAnswer: 1, feedback: "Estimated 2.3 million stone blocks were used." }
                ],
                facts: [
                    "Tallest man-made structure for over 3,800 years.",
                    "Built as a tomb for Pharaoh Khufu.",
                    "Aligned precisely with cardinal directions."
                ]
            },
            // Add Taj Mahal, Colosseum, Machu Picchu, Statue of Liberty from your original data here
             {
                id: "taj-mahal",
                name: "Taj Mahal",
                location: "Agra, India",
                image: "https://placehold.co/300x200/e9c46a/333333?text=Taj+Mahal",
                modelSrc: "https://modelviewer.dev/shared-assets/models/Astronaut.glb", // Placeholder model
                fallbackImage: "https://placehold.co/400x300/e9c46a/333333?text=Taj+Mahal+View",
                description: "An ivory-white marble mausoleum, built by Mughal emperor Shah Jahan for his wife Mumtaz Mahal.",
                questions: [
                    { question: "Built for whom?", options: ["His father", "His wife", "Himself"], correctAnswer: 1, feedback: "It was built as a tomb for his favorite wife, Mumtaz Mahal." },
                    { question: "Primary material?", options: ["Sandstone", "Granite", "White Marble"], correctAnswer: 2, feedback: "The Taj Mahal is renowned for its extensive use of white marble." }
                ],
                facts: [
                    "One of the New7Wonders of the World.",
                    "Took about 22 years to build.",
                    "The four minarets are slightly tilted outwards."
                ]
            }
        ];

        // --- DOM Elements ---
        const screens = {
            welcome: document.getElementById('welcome-screen'),
            selection: document.getElementById('monument-selection'),
            ar: document.getElementById('ar-scene-container'),
            fallback: document.getElementById('fallback-view'),
            quiz: document.getElementById('quiz-container'),
            facts: document.getElementById('edu-facts-container')
        };
        const startExperienceBtn = document.getElementById('start-experience');
        const backToWelcomeBtn = document.getElementById('back-to-welcome');
        const monumentsGrid = document.querySelector('.monuments-grid');
        const monumentModelEntity = document.getElementById('monument-model');
        // Fallback view elements
        const fallbackTitle = document.getElementById('fallback-title');
        const fallbackImage = document.getElementById('fallback-image');
        const fallbackDescription = document.getElementById('fallback-description');
        const startQuizFallbackBtn = document.getElementById('start-quiz-fallback');
        // Quiz elements
        const quizTitle = document.getElementById('quiz-title');
        const quizQuestion = document.getElementById('quiz-question');
        const quizImageStimulus = document.getElementById('quiz-image-stimulus');
        const quizOptionsContainer = document.querySelector('.quiz-options');
        const quizFeedback = document.getElementById('quiz-feedback');
        const currentScoreEl = document.getElementById('current-score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const viewFactsBtn = document.getElementById('view-facts-btn');
        // Educational facts elements
        const eduFactsImage = document.getElementById('edu-facts-image');
        const eduFactsTitle = document.getElementById('edu-facts-title');
        const eduFactsContent = document.getElementById('edu-facts-content');
        const continueBtn = document.getElementById('continue-btn');
        // UI Controls
        const uiControls = document.getElementById('ui-controls');
        const backBtn = document.getElementById('back-btn');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Core Functions ---
        function switchScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
                // Special handling for AR/Fallback to ensure body overflow is managed
                if (screenName === 'ar' || screenName === 'fallback') {
                    document.body.style.overflow = 'hidden';
                    uiControls.classList.remove('hidden');
                } else {
                    document.body.style.overflow = 'auto'; // Or 'hidden' if overlays take full screen
                     if (screenName !== 'quiz' && screenName !== 'facts') { // Keep UI controls hidden unless in AR/Quiz context
                        uiControls.classList.add('hidden');
                    }
                }
                 if (screenName === 'quiz') {
                    screens.quiz.classList.remove('translate-y-full'); // Slide in quiz
                    uiControls.classList.remove('hidden'); // Show back button for quiz
                } else {
                    screens.quiz.classList.add('translate-y-full'); // Slide out quiz
                }

            }
            gameState.currentScreen = screenName;
        }

        function checkARSupport() {
            // Basic check, real AR support detection is more complex
            // For AR.js, it mostly depends on browser getUserMedia and WebGL
            return (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.AFRAME && window.ARjs);
        }
        
        function loadProgress() {
            const saved = localStorage.getItem('ecoQuizProgress');
            if (saved) gameState.completedMonuments = JSON.parse(saved);
        }
        function saveProgress() {
            localStorage.setItem('ecoQuizProgress', JSON.stringify(gameState.completedMonuments));
        }

        function populateMonumentSelection() {
            monumentsGrid.innerHTML = ''; // Clear existing
            monuments.forEach(mon => {
                const isCompleted = gameState.completedMonuments[mon.id];
                const card = document.createElement('div');
                card.className = 'bg-eco-surface rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer';
                card.innerHTML = `
                    <img src="${mon.image}" alt="${mon.name}" class="w-full h-40 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-eco-primary mb-1">${mon.name}</h3>
                        <p class="text-xs text-eco-text-secondary mb-2">${mon.location}</p>
                        <div class="flex justify-between items-center text-xs">
                            <span class="${isCompleted ? 'text-eco-success' : 'text-eco-danger'} font-medium">
                                ${isCompleted ? '<i class="fas fa-check-circle mr-1"></i>Completed' : '<i class="fas fa-times-circle mr-1"></i>Not Completed'}
                            </span>
                            <span class="bg-eco-secondary text-eco-text-primary px-2 py-0.5 rounded-full font-medium">${mon.questions.length} Qs</span>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => startMonumentExperience(mon.id));
                monumentsGrid.appendChild(card);
            });
        }

        function startMonumentExperience(monumentId) {
            gameState.currentMonument = monuments.find(m => m.id === monumentId);
            if (!gameState.currentMonument) return;

            loadingIndicator.classList.remove('hidden');
            
            // Reset quiz state for the new monument
            gameState.currentQuestionIndex = 0;
            gameState.score = 0;
            gameState.questionAnswered = false;
            currentScoreEl.textContent = gameState.score;
            totalQuestionsEl.textContent = gameState.currentMonument.questions.length;


            setTimeout(() => { // Simulate loading
                loadingIndicator.classList.add('hidden');
                if (gameState.arSupported) {
                    switchScreen('ar');
                    // Load 3D model into AR scene
                    if (gameState.currentMonument.modelSrc) {
                        monumentModelEntity.setAttribute('gltf-model', `url(${gameState.currentMonument.modelSrc})`);
                        monumentModelEntity.setAttribute('visible', 'true');
                        // Add tap listener to model to start quiz
                        monumentModelEntity.addEventListener('click', startQuizFromAR, {once: true});
                         // For testing, if marker detection is tricky, show quiz after a delay
                        setTimeout(startQuizFromAR, 3000); // Auto-start quiz after 3s in AR for demo
                    } else {
                        // No model, maybe go to fallback or show error
                        console.warn("No model source for AR for " + gameState.currentMonument.name);
                        setupFallbackView(); // Go to fallback if no model
                    }
                } else {
                    setupFallbackView();
                }
            }, 1500);
        }
        
        function setupFallbackView() {
            const mon = gameState.currentMonument;
            fallbackTitle.textContent = mon.name;
            fallbackImage.src = mon.fallbackImage;
            fallbackDescription.textContent = mon.description;
            switchScreen('fallback');
        }

        function startQuizFromAR() {
            // Hide the AR model or make it non-interactive during quiz if needed
            // monumentModelEntity.setAttribute('visible', 'false'); 
            loadQuestion();
            switchScreen('quiz');
        }
        
        startQuizFallbackBtn.addEventListener('click', () => {
            loadQuestion();
            switchScreen('quiz');
        });


        function loadQuestion() {
            const mon = gameState.currentMonument;
            const qData = mon.questions[gameState.currentQuestionIndex];

            quizTitle.textContent = `${mon.name} - Q${gameState.currentQuestionIndex + 1}`;
            quizQuestion.textContent = qData.question;
            
            if (qData.image) {
                quizImageStimulus.src = qData.image;
                quizImageStimulus.classList.remove('hidden');
            } else {
                quizImageStimulus.classList.add('hidden');
            }

            quizOptionsContainer.innerHTML = '';
            qData.options.forEach((opt, index) => {
                const optBtn = document.createElement('button');
                optBtn.className = 'quiz-option w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-colors focus:outline-none focus:ring-2 focus:ring-eco-info text-sm sm:text-base';
                optBtn.textContent = opt;
                optBtn.addEventListener('click', () => handleOptionSelect(optBtn, index, qData.correctAnswer, qData.feedback));
                quizOptionsContainer.appendChild(optBtn);
            });

            quizFeedback.classList.add('hidden');
            tryAgainBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            viewFactsBtn.classList.add('hidden');
            gameState.questionAnswered = false;
            currentScoreEl.textContent = gameState.score;
        }

        function handleOptionSelect(selectedBtn, selectedIndex, correctIndex, feedbackText) {
            if (gameState.questionAnswered) return;
            gameState.questionAnswered = true;
            gameState.selectedOptionElement = selectedBtn;

            const isCorrect = selectedIndex === correctIndex;
            
            // Visually mark all options
            Array.from(quizOptionsContainer.children).forEach((btn, idx) => {
                btn.disabled = true; // Disable all options
                if (idx === correctIndex) {
                    btn.classList.add('correct');
                    btn.classList.remove('hover:bg-gray-100');
                }
                if (idx === selectedIndex && !isCorrect) {
                    btn.classList.add('incorrect');
                    btn.classList.remove('hover:bg-gray-100');
                }
            });
            selectedBtn.classList.add('selected');


            quizFeedback.textContent = feedbackText;
            quizFeedback.classList.remove('hidden', 'bg-eco-success', 'text-green-700', 'bg-eco-danger', 'text-red-700');
            if (isCorrect) {
                gameState.score++;
                quizFeedback.classList.add('bg-quiz-correct-bg', 'text-quiz-correct-border', 'border', 'border-quiz-correct-border');
                quizFeedback.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Correct! ${feedbackText}`;
            } else {
                quizFeedback.classList.add('bg-quiz-incorrect-bg', 'text-quiz-incorrect-border', 'border', 'border-quiz-incorrect-border');
                quizFeedback.innerHTML = `<i class="fas fa-times-circle mr-2"></i> Incorrect. ${feedbackText}`;
                tryAgainBtn.classList.remove('hidden');
            }
            currentScoreEl.textContent = gameState.score;

            if (gameState.currentQuestionIndex < gameState.currentMonument.questions.length - 1) {
                nextQuestionBtn.classList.remove('hidden');
            } else {
                viewFactsBtn.classList.remove('hidden'); // Last question, show view facts
            }
        }
        
        function showEducationalFacts() {
            const mon = gameState.currentMonument;
            eduFactsImage.style.backgroundImage = `url('${mon.fallbackImage}')`;
            eduFactsTitle.textContent = `${mon.name} - Fun Facts`;
            let factsHTML = `<p class="mb-4 font-medium">${mon.description}</p><ul class="list-disc list-inside space-y-1">`;
            mon.facts.forEach(fact => factsHTML += `<li>${fact}</li>`);
            factsHTML += `</ul>`;
            eduFactsContent.innerHTML = factsHTML;

            gameState.completedMonuments[mon.id] = true;
            saveProgress();
            switchScreen('facts');
        }

        // --- Event Listeners ---
        startExperienceBtn.addEventListener('click', () => {
            populateMonumentSelection();
            switchScreen('selection');
        });
        
        backToWelcomeBtn.addEventListener('click', () => switchScreen('welcome'));

        tryAgainBtn.addEventListener('click', () => {
            // Reset visual state of options for the current question
            Array.from(quizOptionsContainer.children).forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            quizFeedback.classList.add('hidden');
            tryAgainBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            viewFactsBtn.classList.add('hidden');
            gameState.questionAnswered = false;
            // Note: Score is not reset for a retry of the same question unless intended.
        });

        nextQuestionBtn.addEventListener('click', () => {
            gameState.currentQuestionIndex++;
            loadQuestion();
        });
        
        viewFactsBtn.addEventListener('click', showEducationalFacts);

        continueBtn.addEventListener('click', () => {
            populateMonumentSelection(); // Refresh selection screen for completion status
            switchScreen('selection');
        });
        
        backBtn.addEventListener('click', () => {
            // Context-aware back button
            if (gameState.currentScreen === 'ar' || gameState.currentScreen === 'fallback' || gameState.currentScreen === 'quiz') {
                populateMonumentSelection();
                switchScreen('selection');
                 if (gameState.currentScreen === 'ar') {
                    monumentModelEntity.setAttribute('visible', 'false'); // Hide AR model
                    monumentModelEntity.removeAttribute('gltf-model'); // unload model
                }
            } else if (gameState.currentScreen === 'facts') {
                loadQuestion(); // Go back to the last question of the quiz
                switchScreen('quiz');
            } else if (gameState.currentScreen === 'selection') {
                switchScreen('welcome');
            }
        });

        // --- Initialization ---
        function initApp() {
            loadProgress();
            gameState.arSupported = checkARSupport();
            if (!gameState.arSupported) {
                console.warn("AR not fully supported by this browser/device. Fallback will be used.");
            }
            switchScreen('welcome'); // Start at welcome screen
            loadingIndicator.classList.add('hidden'); // Ensure loading is hidden initially
        }

        window.addEventListener('load', initApp);

    </script>
</body>
</html>